steps:
# Clean up resources
- id: 'Delete Cloud Run service'
  name: 'gcr.io/cloud-builders/gcloud:latest'
  entrypoint: /bin/bash
  waitFor: ['Build and deploy to Cloud Run']
  args:
  - '-c'
  - |
    gcloud run services delete $_RUN_SERVICE --quiet || echo 'Failed to delete Cloud Run service.'  | \
    tee -a /workspace/errors.txt

- id: 'Delete VPC access connector'
  name: 'gcr.io/cloud-builders/gcloud:latest'
  entrypoint: /bin/bash
  waitFor: ['Build and deploy to Cloud Run']
  args:
  - '-c'
  - |
    gcloud compute networks vpc-access connectors delete ${_CONNECTOR_NAME} --region ${_REGION} --quiet || \
    echo 'Failed to delete serverless VPC connector.' | \
    tee -a /workspace/errors.txt

- id: 'Delete Filestore instance'
  name: 'gcr.io/cloud-builders/gcloud:latest'
  entrypoint: /bin/bash
  waitFor: ['Build and deploy to Cloud Run']
  args:
  - '-c'
  - |
    gcloud filestore instances delete ${_INSTANCE_ID}  --quiet || \
    echo 'Failed to delete Filestore instance.' | \
    tee -a /workspace/errors.txt
   
- id: 'Delete Artifact Registry build'
  name: 'gcr.io/cloud-builders/gcloud:latest'
  entrypoint: /bin/bash
  waitFor: ['Build and deploy to Cloud Run']
  args:
  - '-c'
  - |
    gcloud artifacts docker images delete \
    us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$_RUN_SERVICE:latest --quiet || \
    echo 'Failed to delete build Artifact Registry.' | \
    tee -a /workspace/errors.txt

- id: 'Pass/Fail'
  name: 'bash'
  args:
  - '-c'
  - |
    cat /workspace/errors.txt 2> /dev/null \
    && exit 2 \
    || echo "End to end test completed successfully." 

substitutions:
  _ZONE: us-central1-a
  _REGION: us-central1
  _SHARE_NAME: share1
  _INSTANCE_ID: run-filesystem-e2e-test
  _CONNECTOR_NAME: run-filesystem-e2e-test
  _RUN_SERVICE: filesystem-app