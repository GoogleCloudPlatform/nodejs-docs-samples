steps:

- id: 'Create VPC Access connector'
  name: 'gcr.io/cloud-builders/gcloud:latest'
  entrypoint: /bin/bash
  args:
  - '-c'
  - |
    gcloud compute networks vpc-access connectors create ${_CONNECTOR} \
      --region ${_REGION} \
      --range 10.8.0.0/28 \
      --network default || echo 'Connector already created.'

- id: 'Build Container Image'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: '/bin/bash'
  args:
  - '-c'
  - |
    ./test/retry.sh "docker build -t gcr.io/${PROJECT_ID}/${_SERVICE}:${_VERSION} ."

- id: 'Push Container Image'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: '/bin/bash'
  args:
  - '-c'
  - |
    ./test/retry.sh "docker push gcr.io/${PROJECT_ID}/${_SERVICE}:${_VERSION}"

- id: 'Deploy to Cloud Run'
  name: 'gcr.io/cloud-builders/gcloud:latest'
  entrypoint: /bin/bash
  args:
  - '-c'
  - |
    ./test/retry.sh "gcloud beta run deploy ${_SERVICE} \
      --image gcr.io/${PROJECT_ID}/${_SERVICE}:${_VERSION} \
      --allow-unauthenticated \
      --region ${_REGION} \
      --set-env-vars REDISHOST=${_REDISHOST} \
      --vpc-connector ${_CONNECTOR}"

images:
- gcr.io/${PROJECT_ID}/${_SERVICE}:${_VERSION}

substitutions:
  _SERVICE: websockets
  _CONNECTOR: my-connector
  _REGION: us-central1
  _REDISHOST: localhost
